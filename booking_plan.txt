# Allbikes Booking System Implementation Plan

This document outlines the plan to create a public booking form for the service page. All new backend code will be integrated into the existing `service` app, and the frontend will be a three-step form to guide the user through the booking process.

---

## Part 1: Backend Implementation (Django `service` app)

### 1.1. Models

**Objective:** Create a model to log all booking requests sent to the Mechanics Desk API for auditing and debugging purposes.

-   **File to be created:** `allbikes/service/models/booking_request_log.py`
-   **Model:** `BookingRequestLog`
-   **Fields:**
    -   `customer_name` (CharField)
    -   `customer_email` (EmailField)
    -   `vehicle_registration` (CharField)
    -   `request_payload` (JSONField): The exact JSON payload sent to Mechanics Desk.
    -   `response_status_code` (IntegerField): The HTTP status code from the Mechanics Desk API response.
    -   `response_body` (JSONField): The JSON response from the Mechanics Desk API.
    -   `created_at` (DateTimeField, auto-now-add=True)
    -   `status` (CharField with choices like 'Success', 'Failed')
-   **File to be modified:** `allbikes/service/models/__init__.py`
    -   **Action:** Import the new `BookingRequestLog` model.

### 1.2. Serializers

**Objective:** Create a serializer to validate the incoming data from the frontend form.

-   **File to be created:** `allbikes/service/serializers.py`
-   **Serializer:** `BookingSerializer(serializers.Serializer)`
-   **Purpose:** To validate the fields required by the Mechanics Desk API.
-   **Fields:** `name`, `email`, `phone`, `registration_number`, `make`, `model`, `year`, `job_type_names` (as an array of strings), `drop_off_time`, `note`, etc.

### 1.3. Views

**Objective:** Create the API views to handle requests from the frontend.

-   **File to be created:** `allbikes/service/views/booking_api_views.py`
-   **View 1: `CreateBookingView(APIView)`**
    -   **Purpose:** Receives the final form data, validates it, constructs the payload for Mechanics Desk (including formatting our custom data into the `note` field), calls the external API via `MechanicsDeskService`, and logs the transaction.
-   **View 2: `GetJobTypesView(APIView)`**
    -   **Purpose:** Provides the list of available job types from Mechanics Desk to the frontend.
-   **View 3: `GetUnavailableDaysView(APIView)`**
    -   **Purpose:** Provides the list of unavailable booking days from Mechanics Desk to the frontend.

### 1.4. URLs

**Objective:** Define the API endpoints for the new views.

-   **File to be created:** `allbikes/service/urls.py`
-   **Endpoints to define:**
    -   `/api/service/create-booking/` -> `CreateBookingView`
    -   `/api/service/job-types/` -> `GetJobTypesView`
    -   `/api/service/unavailable-days/` -> `GetUnavailableDaysView`
-   **File to be modified:** `allbikes/allbikes/urls.py`
    -   **Action:** Include the `service.urls` under the `api/service/` path.

---

## Part 2: Frontend Implementation (React `frontend` app)

### 2.1. High-Level Structure

**Objective:** Create a seamless three-step form experience for the user.

-   **Main Component:** `BookingPage.tsx` will manage the overall state and transitions between the three steps.
-   **State Management:** A single state object in `BookingPage.tsx` will hold all form data.
-   **Persistence:** The `localStorage` API will be used to automatically save form progress. The data will be saved under the key `bookingFormProgress`.

### 2.2. Form Components

-   **File to be created:** `allbikes/frontend/src/pages/BookingPage.tsx`
    -   **Purpose:** The parent container for the booking process.
-   **File to be created:** `allbikes/frontend/src/components/booking/BookingDetailsForm.tsx` (**Step 1: Booking Details**)
    -   **Inputs:** Date Picker, Time Picker, Service Selection, Courtesy Vehicle Request, Notes.
-   **File to be created:** `allbikes/frontend/src/components/booking/BikeDetailsForm.tsx` (**Step 2: Bike Details**)
    -   **Inputs:** Registration Number, Make, Model, Year, VIN, Odometer, etc.
-   **File to be created:** `allbikes/frontend/src/components/booking/PersonalDetailsForm.tsx` (**Step 3: Personal Details**)
    -   **Inputs:** Full Name, Phone, Email, Address.

### 2.3. API Service

**Objective:** Create functions to communicate with the backend.

-   **File to be created/modified:** `allbikes/frontend/src/services/bookingService.ts`
-   **Functions to create:**
    -   `getJobTypes()`: Makes a GET request to `/api/service/job-types/`.
    -   `getUnavailableDays()`: Makes a GET request to `/api/service/unavailable-days/`.
    -   `createBooking(formData)`: Makes a POST request to `/api/service/create-booking/` with the final form data.
